---
title: "Working With Data Hosted on Hugging Face"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working With Data Hosted on Hugging Face}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, include=FALSE}
library(parkinsonsMetagenomicData)
```

# Hugging Face Overview and Setup

## Hugging Face

Individual pipeline output files have been combined into parquet files
and hosted in the
[metagenomics_mac](https://huggingface.co/datasets/waldronlab/metagenomics_mac)
repo on Hugging Face. *Note: some output file types are still pending.*
These are publicly accessible, and are able to be easily read using
DuckDB.

## Parquet Creation

To create the individual parquet files, one needs credentials to access the
`gs://metagenomics-mac` Google Bucket. Instructions on obtaining these can be
found in the [Google Cloud Storage vignette](). These credentials are then
substituted into the following code for the `KEY_ID` and `SECRET` parameters.
Running the following code with [DuckDB](https://duckdb.org/) will generate a
single parquet file containing all of the data from the
`out_pathabundance_cpm_stratified.tsv.gz` files belonging to each sample. For
other output file types, simply change the file path arguments. *Note:
non-HUMAnN file types may have additional changes that will be detailed here as
they are discovered.*

```{sql, eval=FALSE}
install httpfs;
load httpfs;
CREATE SECRET metagenomics_mac (
    TYPE gcs,
    KEY_ID 'KEY_ID',
    SECRET 'SECRET'
);
copy (select * from read_csv_auto('gs://metagenomics-mac/results/cMDv4/*/humann/out_pathabundance_cpm_stratified.tsv.gz', filename=True)) to './parquets/pathabundance_cpm_stratified.parquet' (format parquet, compression 'zstd');
```

## DuckDB in R

DuckDB is very easy to use in R through the `duckdb` R package. The `DBI` and
`dplyr`/`dbplyr` packages combine with it to provide a streamlined way to work
with remote data by selectively querying it before bringing it into your R
session.

Relevant tools:

 - [DuckDB R Client](https://duckdb.org/docs/stable/clients/r.html)
 - [DBI](https://dbi.r-dbi.org/)
 - [dplyr](https://dplyr.tidyverse.org/)/[dbplyr](https://dbplyr.tidyverse.org/)

# Standard Workflow

## Hugging Face and DuckDB Connection

## Loading into R

## Optional View Customization

